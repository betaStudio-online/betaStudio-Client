/*
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                .'                                                                                                                                                                   
                               @@@@.                                                                                                                                                                 
                             @@@@@@@@                                                                                                                                                                
                           ;@@@+  ,@@@@                                                                                                                                                              
                         `@@@@      '@@@;                                                                                                                                                            
                        @@@@`         @@@@.                                                                                                                                                          
                      +@@@:            `@@@@                                                                                                                                                         
                    ,@@@#                ,@@@#                                                                                                                                                       
                  `@@@@                    +@@@:                                                                                                                                                     
                 @@@@.                       @@@@`                                                                                                                                                   
               '@@@'                          `@@@@                                                                                                                                                  
             .@@@@                              :@@@+                                                                                                                                                
            @@@@`                                 #@@@,                                                                                                                                              
           @@@:                                     @@@`                                                                                                                                             
           @@@@`                                  `@@@@`                                                                                                                                             
           @@@@@@                                @@@@@@`                                                                                                                                             
           @@ :@@@#                            +@@@: @@`                                                                                                                                             
           @@   +@@@;                        ,@@@#   @@.        @@@,                                                    :@:  :;                                    ::   :@                           
           @@     @@@@,                    `@@@@     @@.        @@@`                            :@@                    ;;                                          ::                                
           @@      `@@@@                  @@@@`      @@.        @@@                            .@@@                    @           :.                              :.                                
           @@        ,@@@@              ;@@@;        @@.        @@@                            :@@@                    @           :`                              :`                                
           @@          +@@@:          `@@@@          @@.       `@@@@@@@@@+         @@@@@@    :@@@@@@@@    ;@@@@@@@     @          @@@@@@  +`         @       '@@@@@@    .+      @@@@@,               
           @@            @@@@.       @@@@`           @@.       `@@@@@@@@@@@`     #@@@@@@@@+  :@@@@@@@@   @@@@@@@@@@'   ##          #      #          @     +@      +    :;    #'     .@              
           @@             `@@@@    #@@@,             @@.       .@@@@@@@@@@@@    #@@@@  @@@@` ;@@@@@@@@   @:     @@@@    @+         @      #          @    #:       +    ::   ':       `#             
           @@               ,@@@@:@@@+               @@.       :@@@     #@@@#   @@@,    @@@@   @@@@             +@@@     @#        @      @          +   .#        #    :.   @         @             
           @@                 '@@@@@                 @@.       :@@@      @@@@  #@@@     `@@@   @@@@             @@@@      #@       @      @          ;   @         @    ;`  ,;         ;.            
           @@                   @@`                +@@@,       '@@@      #@@@  @@@@@@@@@@@@@   @@@#          :@@@@@@       :@      @      @         `:   @         @    +   @          .'            
           @@                   @@               ,@@@@@,       #@@@      ;@@@  @@@@@@@@@@@@@   @@@+       @@@@@@@@@@        .@     @      @         .:  .+         @    #   @           #            
           @@                   @@             `@@@@ @@,       @@@@      #@@@  @@@;            @@@;     +@@@@@: +@@@         .@    @      @         :.  ::         @    @   @          .;            
           @@                   @@            @@@@,  @@,       @@@@      @@@@  @@@#            @@@;    .@@@#    #@@@          #:   @      @         +   .;         @    @   @          '.            
           @@                   @@          '@@@+    @@,       @@@@     `@@@+  @@@@            @@@;    @@@@     @@@@           @   @      @         @    @         @    @   ::         @             
           @@                   @@        .@@@@      @@,       @@@@@`  `@@@@   `@@@@      :    @@@@    @@@@     @@@@          .+   @      @         #    @        #@    @    @         @             
           @@                   @@       @@@@`       @@,       @@@;@@@@@@@@;    #@@@@@@@@@@    @@@@@@@ :@@@+  : @@@@          @    @      ;.       @@    .#      `;@    @    ''       @              
           @@                   @@     #@@@:         @@,       @@@::@@@@@@'      +@@@@@@@@'    #@@@@@#  @@@@@@' @@@@  @;     @,    @:      #'    :@ @     ,@    '+ @    @     '@    .@               
           @@                   @@   :@@@#           @@,             :@@:          `;@@@:        #@@:     ;@@:          :@@@:       :@@`     :@@:           :@@:                :@@;                 
           @@                   @@ `@@@@             @@:                                                                                                                                             
           @@                   @@@@@@.              @@:                                                                                                                                             
           @@                   @@@@'                @@:                                                                                                                                             
           @@@+                 @@@                ;@@@:                                                                                                                                             
            #@@@:               @@               `@@@@                                                                                                                                               
              @@@@`             @@              @@@@.                                                                                                                                                
               `@@@@            @@            +@@@'                                                                                                                                                  
                 :@@@+          @@          ,@@@@                                                                                                                                                    
                   #@@@,        @@         @@@@`                                                                                                                                                     
                     @@@@`      @@`      @@@@,                                                                                                                                                       
                      .@@@@     @@`    ;@@@+                                                                                                                                                         
                        ;@@@+   @@`  `@@@@                                                                                                                                                           
                          #@@@: @@` @@@@`                                                                                                                                                            
                            @@@@@@#@@@:                                                                                                                                                              
                             `@@@@@@#                                                                                                                                                                
                               :@@@                                                                                                                                                                  
                                 .                                                                                                                                                                   
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
*/

var betaStudio_module_client_authentication_config = betaStudio_module_client.config;/* requires that already jquery and betastudio-client.js are loaded */
var betaStudio_module_client_authentication= function(config){
/*********************************betaStudioModule Info*********************************/
this.module_name = "betaStudio-Client-Authentication";
this.module_description = "This module handles the client side authentication in the betaStudio client."
this.module_license_type = "MIT";
this.module_dependancies = "jQuery|betaStudio_module_client.js";/* if any dependancies like jquery etc, metion here as an info */
this.module_version = "0.1.0";
this.module_lastupdated = "22-09-2017";
this.module_authors = "Samir Dash|";/* Additional authors append your name with a pipe (|) as suffix */
this.module_author_emails = "sdash@redhat.com|";
this.module_help = "Login()|Logout()|Check_Auth()|"/* Additional public methods and props append with a pipe (|) as suffix */
/************************************Config**********************************/    
if(!config){
    
    var config = {
        
    doc:         document,/* target document (with a body tag )object to apply */
    testMode:    false, /* valid values are true|false */
    
   
}; 
if(_testMode){
   console.log("ERROR: "+module_name+": Config not found. Make sure that both  jquery and betastudio-client.js are loaded."); 
}

}else{
    
    var config = config;
    
}
/************************************Public Properties*********************************/
    this.config = config; 
/************************************Public Methods************************************/
 
 this.Logout = function(){
     
  _private_Logout();
 }
 this.Login = function(){
     _private_ShowLogin();
     
 } 
this.Check_Auth = function(){  
   
    _private_Check_Auth();
}


/*******************************Private Properties**************************************/
    
 
 
    
     
    
/*******************************Private Methods**************************************/
 var _private_initAuthentication_banner = function (_doc){
      if(!_doc){var _doc = document; }
   var str =  '<div id="betaStudio_login_modal" style="background: #f7f7f7 url(\'img/bg.jpg\') no-repeat; background-size: contain; background-position: right 0px top 0px;  "><div class="modal_wrap"><img src="betastudio.png" style="width: 250px; position: relative; right: 10px; "/><h1>For Smarter Enterprise.</h1><h2>Login</h2><div id="loginModal"><form id="loginForm" action=""  method="POST"><div class="login-panel panel panel-default"> <div class="panel-body"><div class=""><label class="">username</label><input type="text" name="username" class="form-control" required="required" placeholder="Username"></div><div class="form-group"><label class="">password</label><input type="password" name="passwd" class="" required="required"  placeholder="Password"></div><span id="betaStudio_result" class="alert alert-danger"></span><button type="submit" class="btnLogin">Login</button></div></div></form></div> </div></div>';
    var banner = _doc.createElement("SPAN");
    banner.id="betaStudio_login_modal_wrap";
    banner.innerHTML=str;
    _doc.body.appendChild(banner);
}
var _private_setupLoginFormClient = function (_doc){
     if(!_doc){var _doc = document; }
        // Attach a submit handler to the form
        $( "#loginForm" ).submit(function( event ) {
        _private_HideLogin();
        // Stop form from submitting normally
        event.preventDefault();
        // Get some values from elements on the page:
        var $form = $( this );
        var _username = $form.find( "input[name='username']" ).val();
        var _password = $form.find( "input[name='passwd']" ).val();
        var url = "http://localhost/myBetaStudio/login_api.php"; // $form.attr( "action" );
        // Send the data using post
        var posting = $.post( url, { username: _username, password: _password } );
        // Put the results in a div
        posting.done(function( data ) {
            betaStudio_module_client.userdata.betaStudio_var_username = "";
            betaStudio_module_client.userdata.betaStudio_var_user_type = "";
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "checked";
         _doc.getElementById(betaStudio_module_client.config.dashboardFrame).contentWindow.location  = betaStudio_module_client.config.serverAdminPath+"?loginfromClient=true";
        if(data.indexOf("success")> -1){
            betaStudio_module_clientbetaStudio_module_client.betaStudio_var_username = data.split("||")[1];
            betaStudio_module_clientbetaStudio_module_client.betaStudio_var_user_type = data.split("||")[2];
            betaStudio_module_client.betaStudio_var_last_authentication_status = "login_attempted";
            _private_Update_authentication_ui();
        }else if(data.indexOf("loggedin")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = data.split("||")[1];
            betaStudio_module_client.userdata.betaStudio_var_user_type = data.split("||")[2];
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "checked";
         _private_Update_authentication_ui();
        }else if(data.indexOf("failed")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = data.split("||")[1];
            betaStudio_module_client.userdata.betaStudio_var_user_type = data.split("||")[2];
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "login_attempted";
         _private_Update_authentication_ui();
        }else if(data.indexOf("expired")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = "";
            betaStudio_module_client.userdata.betaStudio_var_user_type = "";
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "checked";
         _private_Update_authentication_ui();

        }; 



        });
        });
}
var _private_ShowLogin = function (){
    $("#"+config.loginModal).show(); 
}
var _private_HideLogin = function (){$("#"+config.loginModal).hide();}
 
var _private_Update_authentication_ui = function (){
     $( "#"+config.resultInspectorPane).empty(); 
     if(betaStudio_module_client.userdata.betaStudio_var_username == ""){
         $( "#"+config.usernameLabelinHeader).empty().append( "Guest" );
         $( "#"+config.logoutLoginLabelinHeader ).empty().append( "<span onclick='betaStudio_module_client_authentication.Login()'>Login</span>" );
         _private_ShowLogin();
         
        }else if(betaStudio_module_client.userdata.betaStudio_var_username != ""){  
         $( "#"+config.usernameLabelinHeader).empty().append( betaStudio_module_client.userdata.betaStudio_var_username );
         $( "#"+config.logoutLoginLabelinHeader ).empty().append( "<span onclick='betaStudio_module_client_authentication.Logout();  '>Logout</span>" );
            _private_HideLogin();
        }else {
         $( "#"+config.usernameLabelinHeader).empty().append( "Guest" );
         $( "#"+config.logoutLoginLabelinHeader ).empty().append( "<span onclick='betaStudio_module_client_authentication.Login()'>Login</span>" ); 
             _private_ShowLogin();
        }
     if(betaStudio_module_client.userdata.betaStudio_var_last_authentication_status == "login_attempted" && betaStudio_module_client.userdata.betaStudio_var_username == "" ){
            $( "#"+config.resultInspectorPane).empty().append( "<span style='color:red'>Username or password incorrect</span>" ); 
            _private_ShowLogin();
        }else{
            $( "#"+config.resultInspectorPane).empty(); 
        }
 }  
var _private_Logout = function (){
            var url = "http://localhost/myBetaStudio/logout_api.php"; // $form.attr( "action" );
            
            var posting = $.post( url, { username: betaStudio_module_client.userdata.betaStudio_var_username    } );
            // Put the results in a div
            posting.done(function( data ) {
            betaStudio_module_client.userdata.betaStudio_var_username = "";
            betaStudio_module_client.userdata.betaStudio_var_user_type = "";
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "checked";
            if(data.indexOf("success")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = data.split("||")[1];
            betaStudio_module_client.userdata.betaStudio_var_user_type = data.split("||")[2];
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "login_attempted";
            _private_Update_authentication_ui();
            }else if(data.indexOf("loggedin")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = data.split("||")[1];
            betaStudio_module_client.userdata.betaStudio_var_user_type = data.split("||")[2];
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "checked";
            _private_Update_authentication_ui();
            }else if(data.indexOf("failed")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = data.split("||")[1];
            betaStudio_module_client.userdata.betaStudio_var_user_type = data.split("||")[2];
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "login_attempted";
            _private_Update_authentication_ui();
            }else if(data.indexOf("expired")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = "";
            betaStudio_module_client.userdata.betaStudio_var_user_type = "";
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "checked";
            _private_Update_authentication_ui();
            }else if(data.indexOf("loggedout")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = "";
            betaStudio_module_client.userdata.betaStudio_var_user_type = "";
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "loggedout";
            config.doc.getElementById(betaStudio_module_client.config.dashboardFrame).contentWindow.location = betaStudio_module_client.config.serverAdminPath;
            _private_Update_authentication_ui();
            }; 
            });

 }  
var _private_Check_Auth = function (){
            var url = "http://localhost/myBetaStudio/check_auth_api.php"; // $form.attr( "action" );
            var posting = $.post( url, { username: betaStudio_module_client.userdata.betaStudio_var_username    } );
            // Put the results in a div
            posting.done(function( data ) {
            betaStudio_module_client.userdata.betaStudio_var_username = "";
            betaStudio_module_client.userdata.betaStudio_var_user_type = "";
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "checked";
            if(data.indexOf("success")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = data.split("||")[1];
            betaStudio_module_client.userdata.betaStudio_var_user_type = data.split("||")[2];
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "login_attempted";
            _private_Update_authentication_ui();
            }else if(data.indexOf("loggedin")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = data.split("||")[1];
            betaStudio_module_client.userdata.betaStudio_var_user_type = data.split("||")[2];
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "checked";
            _private_Update_authentication_ui();
            }else if(data.indexOf("failed")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = data.split("||")[1];
            betaStudio_module_client.userdata.betaStudio_var_user_type = data.split("||")[2];
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "login_attempted";
            _private_Update_authentication_ui();
            }else if(data.indexOf("expired")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = "";
            betaStudio_module_client.userdata.betaStudio_var_user_type = "";
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "checked";
            _private_Update_authentication_ui();

            }else if(data.indexOf("loggedout")> -1){
            betaStudio_module_client.userdata.betaStudio_var_username = "";
            betaStudio_module_client.userdata.betaStudio_var_user_type = "";
            betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "loggedout";
            _private_Update_authentication_ui();

            }; });
     
 }  
       
    
    
    
 

var _private_Init = function(_doc, _testMode){
    if(!_doc){var _doc = document; }
    if(_testMode){
        console.log("***********************************************************************************************************************************");
        console.log("betaStudio::"+module_name+" [Initiated with testMode as true.]");
        console.log("module_version:"+module_version+"");
        console.log("module_lastupdated:"+module_lastupdated+"");
        console.log("module_license_type:"+module_license_type+"");
        console.log("module_description:"+module_description+"");
        console.log("module_authors:"+module_authors+"");
        console.log("module_author_emails:"+module_author_emails+"");
        console.log("module_help:"+module_help+"");
        console.log("***********************************************************************************************************************************");
 
    }
    
    betaStudio_module_client.userdata.betaStudio_var_username = "";
    betaStudio_module_client.userdata.betaStudio_var_user_type = "";
    betaStudio_module_client.userdata.betaStudio_var_last_authentication_status = "checked";  
     
    _private_initAuthentication_banner(_doc);  
    _private_setupLoginFormClient(_doc);
    _private_Check_Auth();  
 
}



_private_Init(config.doc, config.testMode);
return this;
}(betaStudio_module_client_authentication_config);
 
 
