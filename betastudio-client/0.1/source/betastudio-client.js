/*
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                .'                                                                                                                                                                   
                               @@@@.                                                                                                                                                                 
                             @@@@@@@@                                                                                                                                                                
                           ;@@@+  ,@@@@                                                                                                                                                              
                         `@@@@      '@@@;                                                                                                                                                            
                        @@@@`         @@@@.                                                                                                                                                          
                      +@@@:            `@@@@                                                                                                                                                         
                    ,@@@#                ,@@@#                                                                                                                                                       
                  `@@@@                    +@@@:                                                                                                                                                     
                 @@@@.                       @@@@`                                                                                                                                                   
               '@@@'                          `@@@@                                                                                                                                                  
             .@@@@                              :@@@+                                                                                                                                                
            @@@@`                                 #@@@,                                                                                                                                              
           @@@:                                     @@@`                                                                                                                                             
           @@@@`                                  `@@@@`                                                                                                                                             
           @@@@@@                                @@@@@@`                                                                                                                                             
           @@ :@@@#                            +@@@: @@`                                                                                                                                             
           @@   +@@@;                        ,@@@#   @@.        @@@,                                                    :@:  :;                                    ::   :@                           
           @@     @@@@,                    `@@@@     @@.        @@@`                            :@@                    ;;                                          ::                                
           @@      `@@@@                  @@@@`      @@.        @@@                            .@@@                    @           :.                              :.                                
           @@        ,@@@@              ;@@@;        @@.        @@@                            :@@@                    @           :`                              :`                                
           @@          +@@@:          `@@@@          @@.       `@@@@@@@@@+         @@@@@@    :@@@@@@@@    ;@@@@@@@     @          @@@@@@  +`         @       '@@@@@@    .+      @@@@@,               
           @@            @@@@.       @@@@`           @@.       `@@@@@@@@@@@`     #@@@@@@@@+  :@@@@@@@@   @@@@@@@@@@'   ##          #      #          @     +@      +    :;    #'     .@              
           @@             `@@@@    #@@@,             @@.       .@@@@@@@@@@@@    #@@@@  @@@@` ;@@@@@@@@   @:     @@@@    @+         @      #          @    #:       +    ::   ':       `#             
           @@               ,@@@@:@@@+               @@.       :@@@     #@@@#   @@@,    @@@@   @@@@             +@@@     @#        @      @          +   .#        #    :.   @         @             
           @@                 '@@@@@                 @@.       :@@@      @@@@  #@@@     `@@@   @@@@             @@@@      #@       @      @          ;   @         @    ;`  ,;         ;.            
           @@                   @@`                +@@@,       '@@@      #@@@  @@@@@@@@@@@@@   @@@#          :@@@@@@       :@      @      @         `:   @         @    +   @          .'            
           @@                   @@               ,@@@@@,       #@@@      ;@@@  @@@@@@@@@@@@@   @@@+       @@@@@@@@@@        .@     @      @         .:  .+         @    #   @           #            
           @@                   @@             `@@@@ @@,       @@@@      #@@@  @@@;            @@@;     +@@@@@: +@@@         .@    @      @         :.  ::         @    @   @          .;            
           @@                   @@            @@@@,  @@,       @@@@      @@@@  @@@#            @@@;    .@@@#    #@@@          #:   @      @         +   .;         @    @   @          '.            
           @@                   @@          '@@@+    @@,       @@@@     `@@@+  @@@@            @@@;    @@@@     @@@@           @   @      @         @    @         @    @   ::         @             
           @@                   @@        .@@@@      @@,       @@@@@`  `@@@@   `@@@@      :    @@@@    @@@@     @@@@          .+   @      @         #    @        #@    @    @         @             
           @@                   @@       @@@@`       @@,       @@@;@@@@@@@@;    #@@@@@@@@@@    @@@@@@@ :@@@+  : @@@@          @    @      ;.       @@    .#      `;@    @    ''       @              
           @@                   @@     #@@@:         @@,       @@@::@@@@@@'      +@@@@@@@@'    #@@@@@#  @@@@@@' @@@@  @;     @,    @:      #'    :@ @     ,@    '+ @    @     '@    .@               
           @@                   @@   :@@@#           @@,             :@@:          `;@@@:        #@@:     ;@@:          :@@@:       :@@`     :@@:           :@@:                :@@;                 
           @@                   @@ `@@@@             @@:                                                                                                                                             
           @@                   @@@@@@.              @@:                                                                                                                                             
           @@                   @@@@'                @@:                                                                                                                                             
           @@@+                 @@@                ;@@@:                                                                                                                                             
            #@@@:               @@               `@@@@                                                                                                                                               
              @@@@`             @@              @@@@.                                                                                                                                                
               `@@@@            @@            +@@@'                                                                                                                                                  
                 :@@@+          @@          ,@@@@                                                                                                                                                    
                   #@@@,        @@         @@@@`                                                                                                                                                     
                     @@@@`      @@`      @@@@,                                                                                                                                                       
                      .@@@@     @@`    ;@@@+                                                                                                                                                         
                        ;@@@+   @@`  `@@@@                                                                                                                                                           
                          #@@@: @@` @@@@`                                                                                                                                                            
                            @@@@@@#@@@:                                                                                                                                                              
                             `@@@@@@#                                                                                                                                                                
                               :@@@                                                                                                                                                                  
                                 .                                                                                                                                                                   
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
*/

var betaStudio_module_client_config = {
    doc:         document,/* target document (with a body tag )object to apply */
    testMode:    true, /* valid values are true|false */
    useServerLogin :false, /*false - shows inapp logon window  true - uses login form at the site.*/ 
    serverAdminPath:"http://localhost/myBetaStudio/account.php",
    serverPath:"http://localhost/betastudio/",
    betaStudioAddressBar:"betaStudio_url_addressbar",
    betaStudioFrame:"betaStudio_frame",
    betaStudioFrameWrap:"betaStudio_wrpper_container",
    betaStudioFrameGoBt:"betaStudio_url_go",
    betaStudioTestcycleIdLabel:"betaStudio_testcycleid",
    betaStudioSpinner:"betaStudio_spinner", 
    betaStudioRightNav:"betaStudio_right_bar", 
    betaStudioReport:"betaStudio_report",
    betaStudioDashboardBar:"betaStudio_dashboardbar",
    dashboardFrame : "dashboard_frame",
    loginModal:"betaStudio_login_modal",
    resultInspectorPane:"betaStudio_result",
    usernameLabelinHeader:"betaStudio_username",
    logoutLoginLabelinHeader:"betaStudio_loginout",
    betaStudioClientURL:"betaStudio_frame.html",
    betaStudioClientWelcomeURL:"index.html",
    betaStudioClientOfflineIndicator:"betaStudio_offline_indicator",
    cssErrorDetailsPane:"details_pane_csserror",
    jsErrorDetailsPane:"details_pane_jserror",
    accessibilityDetailsPane:"details_pane_accessibility",
    runtimeDetailsPane:"details_pane_runtime",
    colorblineDetailsPane:"details_pane_colorblind",
    xrayDetailsPane:"details_pane_xray",
    screenreaderDetailsPane:"details_pane_screenreader",
    bugreporterDetailsPane:"details_pane_bugreporter" 
    
    
    
    
}
var betaStudio_module_client= function(config){
/*********************************betaStudioModule Info*********************************/
this.module_name = "betaStudio-Client";
this.module_description = "This module setsup the betaStudio client."
this.module_license_type = "MIT";
this.module_dependancies = "jQuery";/* if any dependancies like jquery etc, metion here as an info */
this.module_version = "0.1.1";
this.module_lastupdated = "04-10-2017";
this.module_authors = "Samir Dash|";/* Additional authors append your name with a pipe (|) as suffix */
this.module_author_emails = "sdash@redhat.com|";
this.module_help = "config|userdata|FinishUpdateURL()|showWorkspace()|showDashBoard()|hideReportPanel()|showReportPanel()|showBugReporter()|addOnScreen()|addOnScreen()|showAccessibilityReport()|runAccessibilityReport()|loadURLOnKey()|closeReportPanel()|showJSReport()|showCSSReport()|showRuntimeReport()|openReportPanel()|LoadUsersProjects()|UpdateCurrentProjectDetails()|AppendReport()|AddBug()|AddBugToGithub()|"/* Additional public methods and props append with a pipe (|) as suffix */
/************************************Config**********************************/    
if(!config){
    
    var config = {
        
    doc:document,
    testMode:true,
    useServerLogin :false, /*false - shows inapp logon window  true - uses login form at the site.*/ 
    serverAdminPath:"http://localhost/betastudio/admin/index.php",
    serverPath:"http://localhost/betastudio/",
    betaStudioAddressBar:"betaStudio_url_addressbar",
    betaStudioFrame:"betaStudio_frame",
    betaStudioFrameWrap:"betaStudio_wrpper_container",
    betaStudioFrameGoBt:"betaStudio_url_go",
    betaStudioTestcycleIdLabel:"betaStudio_testcycleid",
    betaStudioSpinner:"betaStudio_spinner", 
    betaStudioRightNav:"betaStudio_right_bar", 
    betaStudioReport:"betaStudio_report",
    betaStudioDashboardBar:"betaStudio_dashboardbar",
    dashboardFrame : "dashboard_frame",
    loginModal:"betaStudio_login_modal",
    resultInspectorPane:"betaStudio_result",
    usernameLabelinHeader:"betaStudio_username",
    logoutLoginLabelinHeader:"betaStudio_loginout",
    betaStudioClientURL:"betaStudio_frame.html",
    betaStudioClientWelcomeURL:"index.html",
    betaStudioClientOfflineIndicator:"betaStudio_offline_indicator",
    cssErrorDetailsPane:"details_pane_csserror",
    jsErrorDetailsPane:"details_pane_jserror",
    accessibilityDetailsPane:"details_pane_accessibility",
    runtimeDetailsPane:"details_pane_runtime",
    colorblineDetailsPane:"details_pane_colorblind",
    xrayDetailsPane:"details_pane_xray",
    screenreaderDetailsPane:"details_pane_screenreader",
    bugreporterDetailsPane:"details_pane_bugreporter"

   
}; }else{
    
    var config = config;
    
}
/************************************Public Properties*********************************/
    this.config = config; 
    
    this.userdata = {
        betaStudio_var_username:"",
        betaStudio_var_user_type:"",
        betaStudio_var_last_authentication_status:"",
        betaStudio_var_projectslist:"",/* the projects dropdown */
        
        betaStudio_var_environment:"",
        betaStudio_var_client:"pc-client",
        
        betaStudio_var_current_project_id:"",
        betaStudio_var_current_project_title:"",
        betaStudio_var_current_project_url:"",
        betaStudio_var_current_testcycle_id:"",
        betaStudio_var_current_report_id:"",
        betaStudio_var_current_report_url:"",
        betaStudio_var_current_report_section_accessibility_inspection_dump:"",
        betaStudio_var_current_report_section_js_inspection_dump:"",
        betaStudio_var_current_report_section_css_inspection_dump:"",
        betaStudio_var_current_report_section_runtime_inspection_dump:"",
        betaStudio_var_current_report_section_colorblind_inspection_dump:"",
        betaStudio_var_current_report_section_screenreader_inspection_dump:"",
        betaStudio_var_current_report_section_cosmetic_xray_inspection_dump:"",
        betaStudio_var_current_report_section_cosmetic_onscreen_inspection_dump:"",
        betaStudio_var_current_report_section_other_inspection_dump:""
        
    
    }
    this.modules = {};
/************************************Public Methods************************************/
 
 this.FinishUpdateURL = function (URL){  
     userdata.betaStudio_var_current_report_url = URL;
     
            if(URL != undefined && URL != null ){ 
            URL = URL.toString();
            $('#' +config.betaStudioSpinner).hide();
            $('#' +config.betaStudioAddressBar).css("color", "#000000");
                _private_checkIframeLoaded();  
            if(URL.indexOf("http://") == 0 ||URL.indexOf("https://") == 0 ){
            
                
                
                document.getElementById(config.betaStudioAddressBar).value = URL; 
                
                
                }else{
                document.getElementById(config.betaStudioAddressBar).value = ""; 
                    
                }
            }
} 
this.showWorkspace = function (){
    $("#"+config.dashboardFrame).hide();$("#"+config.betaStudioFrame).show();
    $("#"+config.betaStudioAddressBar).addClass("selected");
    $("#"+config.betaStudioDashboardBar).removeClass("selected");
    showReportPanel();
} 
this.showDashBoard = function (){
    
    document.getElementById(config.dashboardFrame).src= document.getElementById(config.dashboardFrame).src;
    
    
    $("#"+config.dashboardFrame).show();$("#"+config.betaStudioFrame).hide();
    $("#"+config.betaStudioAddressBar).removeClass("selected");
    $("#"+config.betaStudioDashboardBar).addClass("selected");
    hideReportPanel();

}
this.hideReportPanel = function (){ 
    var _ifrmwrap = document.getElementById(config.betaStudioFrameWrap); 
    var _rightnav = document.getElementById(config.betaStudioRightNav); 
    var _reportWin = document.getElementById(config.betaStudioReport); 

    $(_rightnav).hide();$(_reportWin).hide();
    $(_ifrmwrap).css("width", "100%");
}
this.showReportPanel = function (){
    var _ifrmwrap = document.getElementById(config.betaStudioFrameWrap); 
    var _rightnav = document.getElementById(config.betaStudioRightNav); 
    var _reportWin = document.getElementById(config.betaStudioReport); 
    $(_ifrmwrap).css("width", "calc(100% - 30px)");
    $(_rightnav).show();$(_reportWin).show();


}
this.showBugReporter = function (_navitem){
    _private_clearRightnavHighlight();
    _private_openReportPanel(_navitem);
    document.getElementById("details_pane_bugreporter").style.display = "block";

}    
this.addOnScreen = function (){
    var _ifrm = document.getElementById(config.betaStudioFrame); 
    var _scr = document.createElement("SCRIPT");
    _scr.id="betastudio_onscreen";
    if(_ifrm.contentWindow.document.body.innerHTML.indexOf("http://localhost/betastudio/modules/onscreen/api/js/") == -1){
    _scr.setAttribute("src", "http://localhost/betastudio/modules/onscreen/api/js/index.php");
    _scr.setAttribute("type","text/javascript");
    _ifrm.contentWindow.document.body.appendChild(_scr);

    }


}  
this.showAccessibilityReport = function  (_navitem){
    _private_clearRightnavHighlight();
    _private_openReportPanel(_navitem);
    document.getElementById(config.accessibilityDetailsPane).style.display = "block";

}  
    
this.loadURLOnKey = function (event){
         
    if (event.keyCode == 13) {
       _private_LoadURLInit();
    } 
    }
this.closeReportPanel = function (){
    
}
this.showJSReport = function (_navitem){
    _private_clearRightnavHighlight();
    _private_openReportPanel(_navitem);
document.getElementById(config.jsErrorDetailsPane).style.display = "block";
}
this.showCSSReport = function (_navitem){
    _private_clearRightnavHighlight();
    _private_openReportPanel(_navitem);
    document.getElementById(config.cssErrorDetailsPane).style.display = "block";

}
this.showRuntimeReport = function (){
    _private_clearRightnavHighlight();
    _private_openReportPanel();

}  
this.openReportPanel = function (_navitem){

    var _ifrmwrap = document.getElementById(config.betaStudioFrameWrap); 
    var _rightnav = document.getElementById(config.betaStudioRightNav); 
    var _reportWin = document.getElementById(config.betaStudioReport); 
_ifrmwrap.style.width = "calc(100% - 300px)";
_rightnav.style.right = "270px";
_reportWin.style.right = "0px";
$(_navitem).addClass("selected");
$("#closeicon").show();$("#openicon").hide();
    
}
this.runAccessibilityReport = function (){

 betaStudio_module_accessibilityInspector.runAccessibilityReport();
    
}
this.RunCSSReport = function (){
 
 betaStudio_module_cssInspector.RunCSSReport();
    
}


this.LoadUsersProjects = function(){
    
    
    userdata.betaStudio_var_current_testcycle_id ="";
    var url = "http://localhost/api/projects_api.php";  
            var posting = $.post( url, { user: userdata.betaStudio_var_username    } );
            // Put the results in a div
            posting.done(function( data ) {
            userdata.betaStudio_var_projectslist = data;
               
                _private_Update_Projects_UI();
                
            });
    
    
    
    
    
}
this.UpdateCurrentProjectDetails = function(){
    userdata.betaStudio_var_current_testcycle_id ="";
    var currentStr = document.getElementById(config.betaStudioAddressBar).value;
        
        userdata.betaStudio_var_current_project_id=currentStr.split("||")[0];
        userdata.betaStudio_var_current_project_title=currentStr.split("||")[1];
        userdata.betaStudio_var_current_project_url=currentStr.split("||")[2];
    userdata.betaStudio_var_current_report_url= currentStr.split("||")[2];//initial url for report is same as project url 
     
   
}





this.AppendReport = function(report_id,section_type,str_dump){
    
    
}

this.AddBug = function(report_id,section_type,bug_title, bug_description, bug_status, bug_screenshot){
    
    
}

this.AddBugToGithub = function(bug_id, github_project){
    
    
}




/*******************************Private Properties**************************************/
    
    
/*******************************Private Methods**************************************/
 
   
     

var _private_openReportPanel = function (_navitem){

    var _ifrmwrap = document.getElementById(config.betaStudioFrameWrap); 
    var _rightnav = document.getElementById(config.betaStudioRightNav); 
    var _reportWin = document.getElementById(config.betaStudioReport); 
    _ifrmwrap.style.width = "calc(100% - 300px)";
    _rightnav.style.right = "270px";
    _reportWin.style.right = "0px";
    $(_navitem).addClass("selected");
    $("#closeicon").show();$("#openicon").hide();
    
}

   
var _private_clearRightnavHighlight = function (){
      $("#"+config.betaStudioRightNav+" ul li") .removeClass("selected");
      $("#betaStudio_report .details_pane") .css("display", "none");
         
        
    } 


var _private_LoadCurrentTestCycle = function(){
    
           
         if(userdata.betaStudio_var_current_project_id != ""){var url = "http://localhost/api/testcycle_api.php";  
            var posting = $.post( url, { user: userdata.betaStudio_var_username, project_id: userdata.betaStudio_var_current_project_id, env:userdata.betaStudio_var_environment, client:userdata.betaStudio_var_client   } );
             
            posting.done(function( data ) {
            
             
             var d = JSON.parse(data)
            
            if(d.testcycle_creation_success == true){
            userdata.betaStudio_var_current_testcycle_id = d.testcycle_id;
             
                
            }
           
               
                _private_Update_Projects_UI();
                _private_LoadURL();
                
            });
                                                             
                                                             
                                                            
                                                             
        }else{
            
            
            userdata.betaStudio_var_current_project_url ="welcome.html";
            _private_LoadURL();
            
            
        }
          
          
           
    
    
}

var _private_LoadCurrentReport = function(){
    
           
         if(userdata.betaStudio_var_current_project_id != ""){
             
             var url = "http://localhost/api/add_report_api.php";  
            var posting = $.post( url, { user: userdata.betaStudio_var_username, testcycle_id: userdata.betaStudio_var_current_testcycle_id, url:userdata.betaStudio_var_current_report_url     } );
             
            posting.done(function( data ) {
            
             
             var d = JSON.parse(data)
            
            if(d.report_creation_success == true){
            userdata.betaStudio_var_current_report_id = d.report_id;
             
                alert(userdata.betaStudio_var_current_report_id );
                
            }
           
               
                _private_Update_Projects_UI();
                 //alert("post loading complete");
            RunCSSReport();
            runAccessibilityReport();
             //alert("post runAccessibilityReport ");
                
            });
                                                             
                                                              
                                                            
                                                             
        }else{
            
            
            userdata.betaStudio_var_current_project_url ="welcome.html";
            _private_LoadURL();
            
            
        }
          
          
           
    
    
}


var _private_LoadURLInit = function (){ 
    
    
    
    $('#' +config.betaStudioSpinner).show();
    _private_LoadCurrentTestCycle();
    
    
     
}
var _private_LoadURL = function(){
  
    var app_url = userdata.betaStudio_var_current_project_url; 
         
     var $iframe = $('#' + config.betaStudioFrame);
    if ( $iframe.length ) {
        $iframe.attr('src',app_url);   
        return false;
    }
    return true;
}

$('#' +config.betaStudioFrameGoBt ).bind( "click",_private_LoadURLInit);     
    
    
    
var _private_StartUpdateURL = function (URL){ 
      

            if(URL != undefined){ 
                
                


            
            $('#' +config.betaStudioAddressBar).css("color", "#ff0000");
            if(URL.indexOf("http") == 0){
            document.getElementById(config.betaStudioAddressBar).value = URL; 

            }else{

            document.getElementById(config.betaStudioAddressBar).value ="";
            }

            }
            
             
    
    
}    

var _private_checkIframeLoaded = function () {
    // Get a handle to the iframe element
    var iframe = document.getElementById(config.betaStudioFrame);
    var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

    // Check if loading is complete
    if (  iframeDoc.readyState  == 'complete' ) {
        //iframe.contentWindow.alert("Hello");
        iframe.contentWindow.onload = function(){
            
            
           // alert("I am loaded");
            
            
        }; 
        // The loading is complete, call the function we want executed once the iframe is loaded
        _private_afterLoading();
        
        return;
    } 

    // If we are here, it is not loaded. Set things up so we check   the status again in 100 milliseconds
    window.setTimeout('_private_checkIframeLoaded();', 100);
}
var _private_afterLoading = function (){
     if(userdata.betaStudio_var_current_project_url == "welcome.html"){
        
        
        }else{
            
  _private_LoadCurrentReport();
           
            
        }
    
    
    
}
    
   






var _private_Update_Projects_UI = function(){
    
    if(userdata.betaStudio_var_current_testcycle_id.indexOf("!T") > -1){ $('#'+config.betaStudioTestcycleIdLabel).html("Review-Cycle Id: T"+userdata.betaStudio_var_current_testcycle_id.split("!T")[1]);
   }else{ $('#'+config.betaStudioTestcycleIdLabel).html("Review-Cycle Id: ");
   }
     $('#'+config.betaStudioAddressBar).html(userdata.betaStudio_var_projectslist);
 
}













        
        

var _private_Init = function(_doc, _testMode){
    if(!_doc){var _doc = document; }
    if(_testMode){
        console.log("***********************************************************************************************************************************");
        console.log("betaStudio::"+module_name+" [Initiated with testMode as true.]");
        console.log("module_version:"+module_version+"");
        console.log("module_lastupdated:"+module_lastupdated+"");
        console.log("module_license_type:"+module_license_type+"");
        console.log("module_description:"+module_description+"");
        console.log("module_authors:"+module_authors+"");
        console.log("module_author_emails:"+module_author_emails+"");
        console.log("module_help:"+module_help+"");
        console.log("***********************************************************************************************************************************");
 
    }
    
    
     showDashBoard();
     _doc.getElementById(config.betaStudioFrameWrap).style.width ="calc(100% - 0px)";
     

}



_private_Init(config.doc, config.testMode);
return this;
}(betaStudio_module_client_config);

 
