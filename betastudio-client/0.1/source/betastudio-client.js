/*
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                .'                                                                                                                                                                   
                               @@@@.                                                                                                                                                                 
                             @@@@@@@@                                                                                                                                                                
                           ;@@@+  ,@@@@                                                                                                                                                              
                         `@@@@      '@@@;                                                                                                                                                            
                        @@@@`         @@@@.                                                                                                                                                          
                      +@@@:            `@@@@                                                                                                                                                         
                    ,@@@#                ,@@@#                                                                                                                                                       
                  `@@@@                    +@@@:                                                                                                                                                     
                 @@@@.                       @@@@`                                                                                                                                                   
               '@@@'                          `@@@@                                                                                                                                                  
             .@@@@                              :@@@+                                                                                                                                                
            @@@@`                                 #@@@,                                                                                                                                              
           @@@:                                     @@@`                                                                                                                                             
           @@@@`                                  `@@@@`                                                                                                                                             
           @@@@@@                                @@@@@@`                                                                                                                                             
           @@ :@@@#                            +@@@: @@`                                                                                                                                             
           @@   +@@@;                        ,@@@#   @@.        @@@,                                                    :@:  :;                                    ::   :@                           
           @@     @@@@,                    `@@@@     @@.        @@@`                            :@@                    ;;                                          ::                                
           @@      `@@@@                  @@@@`      @@.        @@@                            .@@@                    @           :.                              :.                                
           @@        ,@@@@              ;@@@;        @@.        @@@                            :@@@                    @           :`                              :`                                
           @@          +@@@:          `@@@@          @@.       `@@@@@@@@@+         @@@@@@    :@@@@@@@@    ;@@@@@@@     @          @@@@@@  +`         @       '@@@@@@    .+      @@@@@,               
           @@            @@@@.       @@@@`           @@.       `@@@@@@@@@@@`     #@@@@@@@@+  :@@@@@@@@   @@@@@@@@@@'   ##          #      #          @     +@      +    :;    #'     .@              
           @@             `@@@@    #@@@,             @@.       .@@@@@@@@@@@@    #@@@@  @@@@` ;@@@@@@@@   @:     @@@@    @+         @      #          @    #:       +    ::   ':       `#             
           @@               ,@@@@:@@@+               @@.       :@@@     #@@@#   @@@,    @@@@   @@@@             +@@@     @#        @      @          +   .#        #    :.   @         @             
           @@                 '@@@@@                 @@.       :@@@      @@@@  #@@@     `@@@   @@@@             @@@@      #@       @      @          ;   @         @    ;`  ,;         ;.            
           @@                   @@`                +@@@,       '@@@      #@@@  @@@@@@@@@@@@@   @@@#          :@@@@@@       :@      @      @         `:   @         @    +   @          .'            
           @@                   @@               ,@@@@@,       #@@@      ;@@@  @@@@@@@@@@@@@   @@@+       @@@@@@@@@@        .@     @      @         .:  .+         @    #   @           #            
           @@                   @@             `@@@@ @@,       @@@@      #@@@  @@@;            @@@;     +@@@@@: +@@@         .@    @      @         :.  ::         @    @   @          .;            
           @@                   @@            @@@@,  @@,       @@@@      @@@@  @@@#            @@@;    .@@@#    #@@@          #:   @      @         +   .;         @    @   @          '.            
           @@                   @@          '@@@+    @@,       @@@@     `@@@+  @@@@            @@@;    @@@@     @@@@           @   @      @         @    @         @    @   ::         @             
           @@                   @@        .@@@@      @@,       @@@@@`  `@@@@   `@@@@      :    @@@@    @@@@     @@@@          .+   @      @         #    @        #@    @    @         @             
           @@                   @@       @@@@`       @@,       @@@;@@@@@@@@;    #@@@@@@@@@@    @@@@@@@ :@@@+  : @@@@          @    @      ;.       @@    .#      `;@    @    ''       @              
           @@                   @@     #@@@:         @@,       @@@::@@@@@@'      +@@@@@@@@'    #@@@@@#  @@@@@@' @@@@  @;     @,    @:      #'    :@ @     ,@    '+ @    @     '@    .@               
           @@                   @@   :@@@#           @@,             :@@:          `;@@@:        #@@:     ;@@:          :@@@:       :@@`     :@@:           :@@:                :@@;                 
           @@                   @@ `@@@@             @@:                                                                                                                                             
           @@                   @@@@@@.              @@:                                                                                                                                             
           @@                   @@@@'                @@:                                                                                                                                             
           @@@+                 @@@                ;@@@:                                                                                                                                             
            #@@@:               @@               `@@@@                                                                                                                                               
              @@@@`             @@              @@@@.                                                                                                                                                
               `@@@@            @@            +@@@'                                                                                                                                                  
                 :@@@+          @@          ,@@@@                                                                                                                                                    
                   #@@@,        @@         @@@@`                                                                                                                                                     
                     @@@@`      @@`      @@@@,                                                                                                                                                       
                      .@@@@     @@`    ;@@@+                                                                                                                                                         
                        ;@@@+   @@`  `@@@@                                                                                                                                                           
                          #@@@: @@` @@@@`                                                                                                                                                            
                            @@@@@@#@@@:                                                                                                                                                              
                             `@@@@@@#                                                                                                                                                                
                               :@@@                                                                                                                                                                  
                                 .                                                                                                                                                                   
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
                                                                                                                                                                                                     
*/

var betaStudio_module_client_config = {
    doc:         document,/* target document (with a body tag )object to apply */
    testMode:    true, /* valid values are true|false */
    useServerLogin :false, /*false - shows inapp logon window  true - uses login form at the site.*/ 
    serverAdminPath:"http://localhost/snoop/admin/index.php",
    serverPath:"http://localhost/snoop/",
    snoopAddressBar:"snoop_url_addressbar",
    snoopFrame:"snoop_frame",
    snoopFrameWrap:"snoop_wrpper_container",
    snoopFrameGoBt:"snoop_url_go",
    snoopSpinner:"snoop_spinner", 
    snoopRightNav:"snoop_right_bar", 
    snoopReport:"snoop_report",
    snoopDashboardBar:"snoop_dashboardbar",
    dashboardFrame : "dashboard_frame",
    loginModal:"snoop_login_modal",
    resultInspectorPane:"snoop_result",
    usernameLabelinHeader:"snoop_username",
    logoutLoginLabelinHeader:"snoop_loginout",
    betaStudioClientURL:"snoop_frame.html",
    betaStudioClientWelcomeURL:"index.html",
    betaStudioClientOfflineIndicator:"snoop_offline_indicator"
    
    
}
var betaStudio_module_client= function(config){
/*********************************betaStudioModule Info*********************************/
this.module_name = "betaStudio-Client";
this.module_description = "This module setsup the betaStudio client."
this.module_license_type = "MIT";
this.module_dependancies = "jQuery";/* if any dependancies like jquery etc, metion here as an info */
this.module_version = "0.1.0";
this.module_lastupdated = "21-09-2017";
this.module_authors = "Samir Dash|";/* Additional authors append your name with a pipe (|) as suffix */
this.module_author_emails = "sdash@redhat.com|";
this.module_help = "config|userdata|FinishUpdateURL()|showWorkspace()|showDashBoard()|hideReportPanel()|showReportPanel()|showBugReporter()|addOnScreen()|addOnScreen()|showAccessibilityReport()|runAccessibilityReport()|loadURLOnKey()|closeReportPanel()|showJSReport()|showCSSReport()|showRuntimeReport()|openReportPanel()|"/* Additional public methods and props append with a pipe (|) as suffix */
/************************************Config**********************************/    
if(!config){
    
    var config = {
        
    doc:document,
    testMode:true,
    useServerLogin :false, /*false - shows inapp logon window  true - uses login form at the site.*/ 
    serverAdminPath:"http://localhost/snoop/admin/index.php",
    serverPath:"http://localhost/snoop/",
    snoopAddressBar:"snoop_url_addressbar",
    snoopFrame:"snoop_frame",
    snoopFrameWrap:"snoop_wrpper_container",
    snoopFrameGoBt:"snoop_url_go",
    snoopSpinner:"snoop_spinner", 
    snoopRightNav:"snoop_right_bar", 
    snoopReport:"snoop_report",
    snoopDashboardBar:"snoop_dashboardbar",
    dashboardFrame : "dashboard_frame",
    loginModal:"snoop_login_modal",
    resultInspectorPane:"snoop_result",
    usernameLabelinHeader:"snoop_username",
    logoutLoginLabelinHeader:"snoop_loginout",
    betaStudioClientURL:"snoop_frame.html",
    betaStudioClientWelcomeURL:"index.html",
    betaStudioClientOfflineIndicator:"snoop_offline_indicator"
        
        

   
}; }else{
    
    var config = config;
    
}
/************************************Public Properties*********************************/
    this.config = config; 
    
    this.userdata = {
        snoop_var_username:"",
        snoop_var_user_type:"",
        snoop_var_last_authentication_status:""
    
    }
/************************************Public Methods************************************/
 
 this.FinishUpdateURL = function (URL){  
            if(URL != undefined && URL != null ){ 
            URL = URL.toString();
            $('#' +config.snoopSpinner).hide();
            $('#' +config.snoopAddressBar).css("color", "#000000");
                _private_checkIframeLoaded();  
            if(URL.indexOf("http") == 0){
            document.getElementById(config.snoopAddressBar).value = URL; 
            }else{
            document.getElementById(config.snoopAddressBar).value = ""; 
            }
            }
} 
this.showWorkspace = function (){
    $("#"+config.dashboardFrame).hide();$("#"+config.snoopFrame).show();
    $("#"+config.snoopAddressBar).addClass("selected");
    $("#"+config.snoopDashboardBar).removeClass("selected");
    showReportPanel();
} 
this.showDashBoard = function (){
    $("#"+config.dashboardFrame).show();$("#"+config.snoopFrame).hide();
    $("#"+config.snoopAddressBar).removeClass("selected");
    $("#"+config.snoopDashboardBar).addClass("selected");
    hideReportPanel();

}
this.hideReportPanel = function (){ 
    var _ifrmwrap = document.getElementById(config.snoopFrameWrap); 
    var _rightnav = document.getElementById(config.snoopRightNav); 
    var _reportWin = document.getElementById(config.snoopReport); 

    $(_rightnav).hide();$(_reportWin).hide();
    $(_ifrmwrap).css("width", "100%");
}
this.showReportPanel = function (){
    var _ifrmwrap = document.getElementById(config.snoopFrameWrap); 
    var _rightnav = document.getElementById(config.snoopRightNav); 
    var _reportWin = document.getElementById(config.snoopReport); 
    $(_ifrmwrap).css("width", "calc(100% - 30px)");
    $(_rightnav).show();$(_reportWin).show();


}
this.showBugReporter = function (_navitem){
    _private_clearRightnavHighlight();
    _private_openReportPanel(_navitem);
    document.getElementById("details_pane_bugreporter").style.display = "block";

}    
this.addOnScreen = function (){
    var _ifrm = document.getElementById(config.snoopFrame); 
    var _scr = document.createElement("SCRIPT");
    _scr.id="betastudio_onscreen";
    if(_ifrm.contentWindow.document.body.innerHTML.indexOf("http://localhost/snoop/modules/onscreen/api/js/") == -1){
    _scr.setAttribute("src", "http://localhost/snoop/modules/onscreen/api/js/index.php");
    _scr.setAttribute("type","text/javascript");
    _ifrm.contentWindow.document.body.appendChild(_scr);

    }


}  
this.showAccessibilityReport = function  (_navitem){
    _private_clearRightnavHighlight();
    _private_openReportPanel(_navitem);
    document.getElementById("details_pane_accessibility").style.display = "block";

}  
this.runAccessibilityReport = function (){
    document.getElementById("details_pane_accessibility").innerHTML ="";
    //var document_DOM = document;
    var document_DOM = document.getElementById(config.snoopFrame).contentWindow.document;
    
    
     // At the moment, it passes the whole DOM document.

    HTMLCS.process('WCAG2AA',document_DOM, function() {
    var messages = HTMLCS.getMessages();
    var length   = messages.length;

    $("#accessibility_inspector  .badge").html(length);

    var msgCount = {};
    msgCount[HTMLCS.ERROR]   = 0;
    msgCount[HTMLCS.WARNING] = 0;
    msgCount[HTMLCS.NOTICE]  = 0;

         
        
        
    for (var i = 0; i < length; i++) {
        str_reporter.output(messages[i]);
        msgCount[messages[i].type]++;
    }
    console.log('done');
    }, function() {
    console.log('Something in AccessibilityInspector failed to parse. Cannot run.');
    console.log('done');
    });

}     
this.loadURLOnKey = function (event){
         
    if (event.keyCode == 13) {
       _private_LoadURL();
    } 
    }
this.closeReportPanel = function (){
    
}
this.showJSReport = function (_navitem){
    _private_clearRightnavHighlight();
    _private_openReportPanel(_navitem);

}
this.showCSSReport = function (_navitem){
    _private_clearRightnavHighlight();
    _private_openReportPanel(_navitem);

}
this.showRuntimeReport = function (){
    _private_clearRightnavHighlight();
    _private_openReportPanel();

}  
this.openReportPanel = function (_navitem){

    var _ifrmwrap = document.getElementById(config.snoopFrameWrap); 
    var _rightnav = document.getElementById(config.snoopRightNav); 
    var _reportWin = document.getElementById(config.snoopReport); 
_ifrmwrap.style.width = "calc(100% - 300px)";
_rightnav.style.right = "270px";
_reportWin.style.right = "0px";
$(_navitem).addClass("selected");
$("#closeicon").show();$("#openicon").hide();
    
}



/*******************************Private Properties**************************************/
    
    
     
var str_reporter= function(){
        
         this.output = function(msg) {


                    
             
             
                        // Simple output for now.
                        var typeName = 'UNKNOWN';
                        switch (msg.type) {
                        case HTMLCS.ERROR:
                        typeName = 'ERROR';
                        break;

                        case HTMLCS.WARNING:
                        typeName = 'WARNING';
                        break;

                        case HTMLCS.NOTICE:
                        typeName = 'NOTICE';
                        break;
                        }//end switch





                        var nodeName = '';
                        if (msg.element) {
                        nodeName = msg.element.nodeName.toLowerCase();
                        }

                        var elementId = '';
                        if (msg.element.id && (msg.element.id !== '')) {
                        elementId = '#' + msg.element.id;
                        }

                        // Clone the node to get it's outerHTML (with inner replaced with ... for brevity)
                        var html = '';
                        if (msg.element.outerHTML) {
                        var node = msg.element.cloneNode(true);
                        node.innerHTML = '...';
                        html = node.outerHTML;
                        }

                        console.log('[HTMLCS] ' + typeName + '|' + msg.code + '|' + nodeName + '|' + elementId + '|' + msg.msg + '|' + html);


                        document.getElementById("details_pane_accessibility").innerHTML = document.getElementById("details_pane_accessibility").innerHTML+('<hr/> ' + typeName + '<br/>' + msg.code + '<br/>' + nodeName + '<br/>' + elementId + '<br/>' + msg.msg + '<br/>' + '<noscript>'+html+'</noscript>');



                        }
         
         
         return this; 
    
    }();
    
     
    
/*******************************Private Methods**************************************/
 
   
     

var _private_openReportPanel = function (_navitem){

    var _ifrmwrap = document.getElementById(config.snoopFrameWrap); 
    var _rightnav = document.getElementById(config.snoopRightNav); 
    var _reportWin = document.getElementById(config.snoopReport); 
_ifrmwrap.style.width = "calc(100% - 300px)";
_rightnav.style.right = "270px";
_reportWin.style.right = "0px";
$(_navitem).addClass("selected");
$("#closeicon").show();$("#openicon").hide();
    
}



        


    
var _private_clearRightnavHighlight = function (){
      $("#"+config.snoopRightNav+" ul li") .removeClass("selected");
      $("#snoop_report .details_pane") .css("display", "none");
         
        
    } 




var _private_LoadURL = function (){ 
    
     $('#' +config.snoopSpinner).show();
     var app_url = document.getElementById(config.snoopAddressBar).value;
    
      
     var $iframe = $('#' + config.snoopFrame);
    if ( $iframe.length ) {
         
        
        
        $iframe.attr('src',app_url);   
        

        return false;
    }
    return true;
}
$('#' +config.snoopFrameGoBt ).bind( "click",_private_LoadURL);     
var _private_StartUpdateURL = function (URL){ 
      

            if(URL != undefined){ 
                
                


            
            $('#' +config.snoopAddressBar).css("color", "#ff0000");
            if(URL.indexOf("http") == 0){
            document.getElementById(config.snoopAddressBar).value = URL; 

            }else{

            document.getElementById(config.snoopAddressBar).value ="";
            }

            }
            
             
    
    
}    

var _private_checkIframeLoaded = function () {
    // Get a handle to the iframe element
    var iframe = document.getElementById(config.snoopFrame);
    var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

    // Check if loading is complete
    if (  iframeDoc.readyState  == 'complete' ) {
        //iframe.contentWindow.alert("Hello");
        iframe.contentWindow.onload = function(){
            
            
           // alert("I am loaded");
            
            
        }; 
        // The loading is complete, call the function we want executed once the iframe is loaded
        _private_afterLoading();
        return;
    } 

    // If we are here, it is not loaded. Set things up so we check   the status again in 100 milliseconds
    window.setTimeout('_private_checkIframeLoaded();', 100);
}
var _private_afterLoading = function (){
     
    //alert("post loading complete");
            runAccessibilityReport();
             // alert("post runAccessibilityReport ");
}
    
   




















        
        

var _private_Init = function(_doc, _testMode){
    if(!_doc){var _doc = document; }
    if(_testMode){
        console.log("***********************************************************************************************************************************");
        console.log("betaStudio::"+module_name+" [Initiated with testMode as true.]");
        console.log("module_version:"+module_version+"");
        console.log("module_lastupdated:"+module_lastupdated+"");
        console.log("module_license_type:"+module_license_type+"");
        console.log("module_description:"+module_description+"");
        console.log("module_authors:"+module_authors+"");
        console.log("module_author_emails:"+module_author_emails+"");
        console.log("module_help:"+module_help+"");
        console.log("***********************************************************************************************************************************");
 
    }
    
    
     showDashBoard();
     _doc.getElementById(config.snoopFrameWrap).style.width ="calc(100% - 0px)";
     
      
    
    
    
    
}



_private_Init(config.doc, config.testMode);
return this;
}(betaStudio_module_client_config);

 
